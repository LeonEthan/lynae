# PR 切分实施计划（基于 PROJECT_DESIGN_FINAL）

更新时间：2026-02-26
依据文档：`docs/PROJECT_DESIGN_FINAL.md`

## 1. 目标
- 将 12 周里程碑落地为可连续合并的 PR 序列。
- 每个 PR 保持单一目标、可验证、可回滚。
- 严格对齐 MVP 范围：`Claude Agent SDK` 单 Provider、本地优先、安全先行。

## 2. 切分原则
- 先基础设施，后能力闭环，再稳定性与发布。
- 每个 PR 必须包含：变更说明、验证方式、风险点与回滚方式。
- 接口先行：跨包能力先定义契约，再接具体实现。
- Runtime 侧坚持“薄适配层”：优先复用 Agent SDK 原生能力，不重复造 Runtime 内核。
- 高风险能力（命令执行、文件写入、网络放行）默认 `deny`，审批后放行。

## 3. 分支与合并策略
- 主干：`main`
- 分支命名：`feat/pr-xx-<short-topic>`
- 提交类型：`docs:` `feat:` `fix:`（与仓库约定一致）
- 合并门槛（代码入仓后执行）：
  - 单元测试通过
  - 关键 E2E 用例通过（从 Phase 2 起）
  - 安全策略相关改动需包含负向测试（未审批时必须拦截）

## 4. PR 序列（按阶段）

### Phase 0（第 1-2 周）：架构打底

### PR-01：Monorepo 与工程基线
- 范围：
  - 初始化 `apps/desktop`、`packages/agent-core`、`packages/runtime-adapters/claude`、`packages/toolkit`、`packages/policy-engine`、`packages/storage`
  - 建立 TypeScript 工程引用、统一 lint/format/test 脚本占位
- 产出：
  - 可安装、可构建的最小 monorepo
  - 根目录开发脚本（`dev/build/test/lint`）
- 验收标准：
  - 所有 package 可被 workspace 识别
  - `apps/desktop` 可启动空壳窗口
- 依赖：无

### PR-02：桌面壳层与基础会话 UI
- 范围：
  - Electron 主进程 + React 渲染进程
  - 基础布局：会话列表、聊天区、任务区占位
- 产出：
  - 桌面端可运行的三栏基础工作台
  - UI 与主进程最小通信通道
- 验收标准：
  - 本地可创建/切换空会话
  - 页面刷新后会话列表可恢复（先内存或假数据）
- 依赖：PR-01

### PR-03：IPC 契约与事件模型
- 范围：
  - 定义 `RuntimeEvent`、`ToolEvent`、`ApprovalEvent` 基础类型
  - 建立主进程 <-> 渲染进程 typed IPC 层
- 产出：
  - 统一事件协议与消息路由
  - 事件回放接口（占位）
- 验收标准：
  - UI 可接收并渲染模拟流式事件
  - IPC 层具备类型检查与错误上报
- 依赖：PR-02

### PR-04：SQLite + Drizzle 存储基线
- 范围：
  - `packages/storage` 建立 schema：`sessions/messages/tool_executions/approvals/settings`
  - migration、基础 DAO/Repository
- 产出：
  - 本地数据库初始化能力
  - 会话与消息基础读写
- 验收标准：
  - 新建会话/消息可持久化并重启恢复
  - migration 可重复执行且幂等
- 依赖：PR-01

### Phase 1（第 3-5 周）：MVP 核心闭环

### PR-05：Agent Core 状态机（Plan/Execute 骨架）
- 范围：
  - 在 `packages/agent-core` 实现任务状态机与执行上下文
  - 定义 Plan -> 审批 -> Execute 主流程
- 产出：
  - 可驱动模拟任务的状态机
  - 中断/取消接口占位
- 验收标准：
  - 状态流转可追踪且可回放
  - UI 可显示当前任务阶段
- 依赖：PR-03、PR-04

### PR-06：Claude Adapter 接入（单 Runtime）
- 范围：
  - 实现 `AgentRuntime` 接口（`createSession/runTurn/cancel/listCapabilities`）
  - 封装 Claude Agent SDK（`@anthropic-ai/claude-agent-sdk`），屏蔽 Provider 差异
  - 仅实现 SDK 启动、事件映射、错误归一化，不承载复杂业务编排
- 产出：
  - 可流式返回文本与工具调用事件（统一为 `RuntimeEvent`）
  - 运行时能力声明（capabilities）
- 验收标准：
  - 业务层不直接依赖 `@anthropic-ai/claude-agent-sdk` 或 `@anthropic-ai/sdk`
  - Runtime 路径不引入 `@anthropic-ai/sdk`
  - `claude-adapter` 不重复实现会话历史管理、手写 tool loop、底层流事件拼装解析
  - Plan/Execute、审批、策略、审计逻辑不下沉到 runtime-adapter
  - 最小对话可端到端通
- 依赖：PR-05

### PR-07：文件工具链（读写/搜索/批量修改）+ 工作区边界
- 范围：
  - `packages/toolkit` 实现 file 工具
  - 路径约束：仅允许 workspace 内访问
- 产出：
  - 文件读取、写入、搜索、批量替换
  - 路径越界拦截与审计记录
- 验收标准：
  - 越界访问被拒绝
  - 修改后可返回 diff 摘要
- 依赖：PR-05

### PR-08：终端工具链（命令执行/超时/资源限制）
- 范围：
  - 集成 `node-pty`，实现命令执行与流式输出
  - 默认 deny + allowlist 检查
- 产出：
  - 可配置超时、并发上限、进程取消
  - 命令执行审计日志
- 验收标准：
  - 未放行命令不可执行
  - 超时任务可强制终止并记录原因
- 依赖：PR-05、PR-04

### PR-09：Git 工具链（status/diff/branch/commit/push）
- 范围：
  - 实现 Git 基础能力与错误映射
  - 预留 PR 草稿描述生成接口
- 产出：
  - 本地仓库状态感知与提交闭环
  - 危险操作标记（如 force push）
- 验收标准：
  - 常见 Git 子命令路径稳定
  - 高风险命令进入审批流程
- 依赖：PR-05、PR-08

### PR-10：审批中心（命令级/文件级/网络级）
- 范围：
  - `packages/policy-engine` 初版规则评估
  - 前端审批面板与一次性/会话级授权
- 产出：
  - 审批记录落库
  - 审批结果驱动工具执行放行/拒绝
- 验收标准：
  - 未审批请求默认拦截
  - 审批决定可追溯至具体工具调用
- 依赖：PR-07、PR-08、PR-09

### PR-11：checkpoint 与回滚
- 范围：
  - 针对文件与 Git 改动建立 checkpoint
  - 提供失败回滚与手动回退接口
- 产出：
  - 执行前快照、执行后差异对比
  - 回滚操作审计
- 验收标准：
  - 失败任务可恢复到执行前状态
  - 回滚过程可复盘
- 依赖：PR-07、PR-09、PR-10

### PR-12：审计与会话回放（首版）
- 范围：
  - 聚合消息、工具调用、审批、diff、命令输出
  - 提供按会话查询与时间线视图
- 产出：
  - 最小闭环审计能力
  - 导出接口（JSON）
- 验收标准：
  - 任一任务可回放关键操作链
  - 可定位“谁在何时批准了什么”
- 依赖：PR-10、PR-11、PR-04

### Phase 2（第 6-8 周）：稳定性强化

### PR-13：长任务恢复与重试治理
- 范围：
  - 任务持久化状态恢复
  - 分类重试策略（可重试/不可重试）
- 产出：
  - 应用重启后可恢复未完成任务
  - 失败原因分层与重试上限
- 验收标准：
  - 中断后恢复成功率达到目标基线
  - 不可重试错误不进入死循环
- 依赖：PR-12

### PR-14：策略引擎增强（命令/路径/网络三级规则）
- 范围：
  - 规则 DSL 或配置模型
  - 风险分级（低/中/高）与强制二次确认
- 产出：
  - 可配置策略集与热加载（本地）
  - 高危动作模板（`rm -rf`、`git push --force` 等）
- 验收标准：
  - 高危动作必须二次确认
  - 规则冲突时有确定性决策
- 依赖：PR-10、PR-13

### PR-15：测试体系（契约 + 集成 + E2E）
- 范围：
  - Runtime Adapter 契约测试
  - Tool Runner 与 Policy Engine 集成测试
  - 关键路径 E2E：对话 -> 改码 -> 验证 -> 提交
- 产出：
  - 测试金字塔最小闭环
  - CI 测试任务（代码入仓后）
- 验收标准：
  - 关键路径稳定通过
  - 安全负向用例全通过
- 依赖：PR-13、PR-14

### Phase 3（第 9-12 周）：Beta 发布能力

### PR-16：PR 辅助流程完善
- 范围：
  - 变更摘要、风险提示、PR 草稿模板
  - 将审计信息映射为可读发布说明
- 产出：
  - 一键生成 PR 草稿内容
  - 风险与影响面提示
- 验收标准：
  - PR 草稿可直接用于人工审阅
  - 风险提示覆盖高危变更
- 依赖：PR-12、PR-15

### PR-17：安装包、自动更新、崩溃监控
- 范围：
  - Electron Builder 打包
  - 自动更新机制与崩溃上报
- 产出：
  - macOS/Windows 安装包（MVP 范围）
  - 崩溃日志最小采集闭环
- 验收标准：
  - 安装、启动、更新流程可用
  - 崩溃可定位到版本与堆栈
- 依赖：PR-15

### PR-18：Beta 文档与发布闸门
- 范围：
  - 补齐用户文档、运维文档、风险告知
  - 发布前检查清单与回滚预案
- 产出：
  - Beta 发布手册
  - 验收指标看板定义（成功率、恢复率、崩溃率）
- 验收标准：
  - 可按清单完成一次端到端演练
  - 指标采集口径清晰可执行
- 依赖：PR-16、PR-17

## 5. 并行实施建议
- 可并行 A：PR-04（存储）与 PR-02/03（桌面与 IPC）并行推进。
- 可并行 B：PR-07（文件工具）与 PR-08（终端工具）并行，统一在 PR-10 汇合审批策略。
- 可并行 C：PR-16（PR 辅助）与 PR-17（发布工程）并行，PR-18 做最终收口。

## 6. 风险控制与回滚策略（按 PR 执行）
- 每个 PR 必须附回滚说明：数据库迁移回滚、特性开关、接口兼容策略。
- 安全相关 PR（07/08/10/14）必须包含未授权拦截测试。
- Runtime 适配 PR（06）必须包含契约测试，避免 Agent SDK 升级破坏上层。
- Runtime 相关 PR 需附“边界检查”：新增逻辑默认放在 `agent-core/policy/toolkit`，防止适配层变厚。

## 7. 完成定义（DoD）
- 功能可用：满足该 PR 验收标准。
- 可观测：关键日志、错误码、审计字段齐全。
- 可测试：至少包含对应层级自动化测试或明确人工验证步骤。
- 可回滚：在不破坏用户工作区数据的前提下可撤回。
